<script>
	
	// Funzione per fare una richiesta al backend e gestire la risposta
		async function fetchWithAuth(url, options = {}) {
			console.log("url"+url+" and options"+ options);
	    try {

	        const response = await fetch(url, options);

	        if (response.ok) {
			
					const authHeader = response.headers.get('Authorization');
					console.log("okokok "+authHeader);

	            if (authHeader && authHeader.startsWith('Bearer ')) {

	                const token = authHeader.substring(7); // Rimuovi "Bearer "

					localStorage.setItem('token', token);
					
					//const loc=response.headers.get('Location');
					return await "authenticated";//modificato qui

	            }
				
				throw new Error('Errore nella richiesta interno: ' + response.statusText);
				//response.json();
	        } else {
	            throw new Error('Errore nella richiesta: ' + response.statusText);
	        }
	    } catch (error) {
	        console.error('Errore:', error);
	        throw error;
	    }
	}

	
	
	// Funzione per effettuare il login e ottenere il token
		async function login(email, password) {
		    const urlDoubleServer = 'http://security-service/auth/login';
			const url = '/auth/login';

		    const options = {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify({ email, password })
		    };

		    try {

		        const data = await fetchWithAuth(urlDoubleServer, options);
		        console.log('Login avvenuto con successo:', data);
		        return 	loggedPage();
		;
		    } catch (error) {
				try{
					const data = await fetchWithAuth(url, options);
							console.log('Login avvenuto con successo:', data);
							return 	loggedPage();
				}catch(error2)
				{
					console.error('Errore nel login:', error);

				}
				

		    }
		};
	
	// Esempio di utilizzo
	document.getElementById('loginForm').addEventListener('submit', async function (event) {
	    event.preventDefault();

	    const email = document.getElementById('email').value;
	    const password = document.getElementById('password').value;

	   	const nextAddress=await login(email, password);

	    // Dopo il login, puoi fare altre chiamate API
	});
	
	
	
	



document.querySelectorAll(".apiLink").forEach(function(element) {
    element.addEventListener('submit', async function(event) {
        event.preventDefault();
		
		console.log("prima di if"); 

		const form = event.target;
		const action = form.action;
		const method = form.method.toUpperCase() || 'POST';
		
        const token = localStorage.getItem('token');
		
		const formData = new FormData(form);
		const params = new URLSearchParams();
		       formData.forEach((value, key) => {
		           params.append(key, value);
				   
		       });


		const fetchOptions = {
		           method: method,
		           headers: {
		              // 'Content-Type': 'application/x-www-form-urlencoded',
					   'Authorization': 'Bearer ' + localStorage.getItem('token')
		           }
		       };
			   if (method === 'GET') {
			       // Aggiungi i parametri all'URL per la richiesta GET
				   
					if (params === undefined || params === null || params == "" || params==" " ){

						action += params.toString();
					}else{
						action += '?' + params.toString();
					}
					

			   } else {
			       // Includi i parametri nel corpo per le richieste POST
			       fetchOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
			       fetchOptions.body = params.toString();
			   }
			   try {
			              const response = await fetch(action, fetchOptions);

						  if (response.ok||response.status==302) {
						  		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
						  		       const html = await response.text();
						  		       document.open();
						  		       document.write(html);
						  		       document.close();
						  		   } else {
						  		       console.error('Errore nella richiesta:', response.status);
						  		   }
			           
			          } catch (error) {
			              console.error('Errore durante la richiesta:', error);
			          }
			   
    });
});






// Esempio di utilizzo
document.getElementById('logout').addEventListener('submit', async function (event) {
    event.preventDefault();

	localStorage.setItem("token","");
	
	const form = event.target;
	const actionUrl = form.getAttribute('action');

	console.log("action url:::"+actionUrl);
	window.location.href = actionUrl;
});




async function loggedPage() {
    const url ="/gestionale/in/view";
	console.log("url in logged page :"+url);
    const token = localStorage.getItem('token');
	console.log(token);
    if (!token) {
        console.error('Token non trovato. Effettua il login prima di fare questa richiesta.');
        return;
    }

    const options = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        }
    };

    try {
		const response = await fetch(url, options);
		if (response.ok) {
		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
		       const html = await response.text();
		       document.open();
		       document.write(html);
		       document.close();
		   } else {
		       console.error('Errore nella richiesta:', response.status);
		   }

       // const data = await fetchWithAuth(url, options);
        console.log('Dati ricevuti:', response);
		console.log("token alla fine"+localStorage.getItem('token'))
    } catch (error) {
        console.error('Errore nella chiamata API:', error);
    }
}




</script>
</html>


