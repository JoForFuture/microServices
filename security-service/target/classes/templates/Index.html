</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta content="IE=edge" http-equiv="X-UA-Compatible">
	<title >Gestionale</title>
</head>

<body>
	<!--<button id="backButton">Back</button>-->
	<form id="backForm" action="#" method="get">
			<button type="submit">Back</button>
	</form>
	<br>
	<form  class="apiLink" th:action="@{/gestionale/in/view}" method="get">
				<button type="submit">Home</button>
	</form>

	<br>
	<form id="logout" th:action="@{/auth/logout}" method="get">
		<button type="submit">Logout</button>
	</form>

	<h2 	id="gestionaleTitle">Gestionale</h2>

	

	<!--********************INDEX PAGE********************************-->
	<div th:if="${indexPage_isVisible eq true}">
		<!--  /gestionale/in/view-->
		<!-- Bottone per aggiungere un utente -->
		<form  class="apiLink" th:action="@{/formLogin/view}" method="get">
			<button type="submit">Login</button>
		</form>
		
	</div>
	
	<!--********************BEFORE LOGIN********************************-->
		<div th:if="${beforeLoginPage_isVisible eq true}">
			<!-- Bottone per aggiungere un utente -->
			<h2>Access denied</h2>
			
			<form  class="apiLink" th:action="@{/formLogin/view}" method="get">
						<button type="submit">Change user</button>
			</form>
		
		</div>
		
	<!--********************GESTIONALE IN******************************
		
		**-->
	<div th:if="${gestionaleIn_isVisible eq true}">
		<!--<h2 th:text="'Benvenuto '+${user.getUsername()}+' !'"></h2>-->
		<!-- Bottone per aggiungere un utente -->
		<form 	class="apiLink" th:action="@{/private/addToPeopleGroup/view}" method="get">
			<button type="submit">Aggiungi persona</button>
		</form>
		<form 		class="apiLink" th:action="@{/searchPerson/view}" method="get">
			<button type="submit">Cerca persona</button>
		</form>
		<form 		class="apiLink" th:action="@{/api/view/person/getAll}" method="get">
			<button type="submit">Lista persone</button>
		</form>
		<form 		class="apiLink" th:action="@{/api/view/person/getAllReactive}" method="get">
			<button type="submit">Lista persone reattiva</button>
		</form>

	</div>
	<!--************************FORM LOGIN*****************************************-->
	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formLogin_isVisible eq true}">
		<h3>Form login</h3>
		<!-- <form action="#" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post"> -->


		<form id="loginForm" th:if="${param.loginFailed}" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post">
			<input type="text" id="email" name="email" placeholder="Email" />
			<input type="password" id="password" name="password" placeholder="Password" />
			<button type="submit">Login</button>
		</form>

		<form 	id="loginForm" th:unless="${param.loginFailed}" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post">
			<input type="text" id="email" name="email" th:value="${param.email}" placeholder="Email" />
			<input type="password" id="password" name="password" placeholder="Password" />
			<button type="submit">Login</button>
		</form>


		<!--  </form>  -->
	</div>

	<!--********************FORM ADD TO PEOPLE GROUP********************************-->

	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formAddToPeopleGroup_isVisible eq true}">
		<h3>Inserimento Persona</h3>
		<h4>Cognome e Nome sono obbligatori</h4>

		<form class="apiLink" action="#" th:action="@{/api/view/person/private/add}" th:object="${person}" method="post">
			<label for="name">Nome:</label>
			<input type="text" id="name" th:field="*{name}" required="true" /><br />

			<label for="surname">Cognome:</label>
			<input type="text" id="surname" th:field="*{surname}" required="true" /><br />

			<label for="age">Età:</label>
			<input type="number" id="age" th:field="*{age}" /><br />

			<input type="submit" value="Salva" />
		</form>
	</div>

	<!--********************FORM SEARCH PERSON********************************-->

	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formSearchPerson_isVisible eq true}">
		<h3>Cerca persona</h3>
		<h4>Cognome e Nome sono obbligatori</h4>
<!--(surname=${person.surname},name=${person.name})-->
		<form class="apiLink" action="#"  th:action="@{/api/view/person/getByNameAndSurname}" th:object="${person}" method="get">
			
			<label for="name">Nome:</label>
			<input type="text" id="name" th:field="*{name}" required="true" /><br />


			<label for="surname">Cognome:</label>
			<input type="text" id="surname" th:field="*{surname}" required="true" /><br />

			<input type="submit" value="Cerca" />
		</form>
	</div>

	<!--********************GET PERSON DETAILS PAGE********************************-->

	<!-- Mostra la risposta ricevuta dal backend -->
	<div th:if="${getPersonDetailsPage_isVisible eq true}">
		<h3>Dettagli persona</h3>

		<strong>
			<p th:text="${response}"></p>
		</strong>
		<br>
		<p th:text="${person.getName()}"></p>
		<br>
		<p th:text="${person.getSurname()}"></p>
		<br>
		<p th:text="${person.getAge()}"></p>
		<br>

		<form class="apiLink" th:action="@{/private/updateMemberOfPeopleGroup/view(id=${person.getId()})}" method="get">
			
			

			<button type="submit">aggiorna </button>

		</form>
		<form  class="apiLink" th:action="@{/private/deleteMemberOfPeopleGroup/view(id=${person.getId()})}" method="get">

			<button type="submit">cancella </button>

		</form>



	</div>

	<!--********************GET ALL PERSON********************************-->
	<!-- Mostra la risposta ricevuta dal backend -->
	<div th:if="${getPersonArray_isVisible eq true}">
		<h3>Lista persone</h3>

		<strong>
			<p th:text="${response}"></p>
		</strong>


		<td><strong>DETTAGLI PERSONA:</strong> </td>

		<tr th:each="singlePerson : ${personList}">
			<br>
						<td th:text="'ID : '+${singlePerson.getId()}"></td>
			<br>
			<td th:text="'NOME : '+${singlePerson.getName()}"></td>
			<br>
			<td th:text="'COGNOME : '+${singlePerson.getSurname()}"></td>
			<br>
			<td th:text="'AGE : '+${singlePerson.getAge()}"></td>
			<br>
			<br>
		</tr>


	</div>

	<!--********************GET ALL PERSON REACTIVE********************************-->
	<div>
		<!-- Mostra la risposta ricevuta dal backend -->
		<div th:if="${getPersonArrayReactive_isVisible eq true}">
			<h3>Lista persone</h3>

			<strong>
				<p th:text="${response}"></p>
			</strong>


			<td><strong>DETTAGLI PERSONA:</strong> </td>
			
			<div>
				<th:tr th:each="single:${personFlux}">
					<td th:text="${personFlux}"></td>
					<br><br>
					<td th:text="${single}"></td>
					
				</th:tr>
			</div>

		
			
		</div>
	</div>
	<!--********************UPDATE PERSON********************************-->
	<div th:if="${updateMemberOfPeopleGroup_isVisible eq true}">
		<form class="apiLink" action="#" th:action="@{/api/view/person/private/update(id=${person.id})}" th:object="${person}"
			method="post">

			<input type="hidden" name="_method" value="PUT" />

			<!--<p th:text="'id :'+${person.getId()}"></p><input  type="hidden" id="id" name="id" th:value="${person.getId()}">-->
			<br>
			<p th:text="${person.getName()}"></p> <input type="text" id="name" th:field="*{name}">
			<br>
			<p th:text="${person.getSurname()}"></p> <input type="text" id="surname" th:field="*{surname}">
			<br>
			<p th:text="${person.getAge()}"></p> <input type="number" id="age" th:field="*{age}">
			<br>
			<input type="submit" value="Aggiorna" />



		</form>

	</div>
	<!--********************DELETE PERSON********************************-->
	<div th:if="${deleteMemberOfPeopleGroup_isVisible eq true}">
		<!--<div th:unless="${person.getId() ==null}">-->
		<form class="apiLink" action="#" th:action="@{/api/view/person/private/delete(id=${person.id})}" th:object="${person}"
			method="post">
			<h2>Conferma elimina dati persona</h2>
			<br>
			<p>Persona:</p>
			<input type="hidden" name="_method" value="DELETE" />

			<p th:text="'id :'+${person.getId()}"></p>
			<!--<input  type="hidden" id="id" name="id" th:value="${person.getId()}">-->
			<br>
			<p th:text="'name :'+${person.getName()}"></p>
			<br>
			<p th:text="'surname :'+${person.getSurname()}"></p>
			<br>
			<p th:text="'age :'+${person.getAge()}"></p>
			<br>
			<input type="submit" value="Cancella" />
		</form>
		<!-- </div>-->
		<!--	 <div th:if="${person.getId() == null}">
			<p th:text="${deleteMemberOfPeopleGroup_isVisible=false} = "></p>
			<p th:text="${gestionaleIn_isVisible_isVisible=true} = "></p>

		 </div>-->
	</div>
	<!--********************ERRORE INSERIMENTO********************************-->

	<div th:if="${getErrorPage_isVisible eq true}">
		<h1>Qualcosa non è andato bene!</h1>
		<br>
		<br>
		<!-- Mostra la risposta ricevuta dal backend 	 -->

		<strong>
			<p>L'errore è il seguente:</p>
		</strong>
		<p th:text="${errorMessage}"></p>

	</div>



</body>

<script>
	

	
	// Funzione per fare una richiesta al backend e gestire la risposta
	async function fetchWithAuth(url, options = {}) {
		console.log(url+" and "+ options);
    try {

        const response = await fetch(url, options);

        if (response.ok) {
		
				const authHeader = response.headers.get('Authorization');
				console.log("okokok "+authHeader);

            if (authHeader && authHeader.startsWith('Bearer ')) {

                const token = authHeader.substring(7); // Rimuovi "Bearer "

				localStorage.setItem('token', token);
				
				//const loc=response.headers.get('Location');
				return await "authenticated";//modificato qui

            }
			
			throw new Error('Errore nella richiesta interno: ' + response.statusText);
			//response.json();
        } else {
            throw new Error('Errore nella richiesta: ' + response.statusText);
        }
    } catch (error) {
        console.error('Errore:', error);
        throw error;
    }
}

// Funzione per effettuare il login e ottenere il token
async function login(email, password) {
    const url = 'http://localhost:8081/auth/login';
    const options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
    };

    try {

        const data = await fetchWithAuth(url, options);
        console.log('Login avvenuto con successo:', data);
        return 	loggedPage();
;
    } catch (error) {
        console.error('Errore nel login:', error);
    }
}


document.querySelectorAll(".apiLink").forEach(function(element) {
    element.addEventListener('submit', async function(event) {
        event.preventDefault();
		
		const form = event.target;
		let action = form.action;
		const method = form.method.toUpperCase() || 'POST';
		
        const token = localStorage.getItem('token');
		
		const formData = new FormData(form);
		const params = new URLSearchParams();
		       formData.forEach((value, key) => {
		           params.append(key, value);
				   
		       });

			   

		const fetchOptions = {
		           method: method,
		           headers: {
		              // 'Content-Type': 'application/x-www-form-urlencoded',
					   'Authorization': 'Bearer ' + token
		           }
		       };
			   if (method === 'GET') {
			       // Aggiungi i parametri all'URL per la richiesta GET
				   
					if (params === undefined || params === null || params == "" || params==" " ){

						action += params.toString();
					}else{
						action += '?' + params.toString();
					}
					

			   } else {
			       // Includi i parametri nel corpo per le richieste POST
			       fetchOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
			       fetchOptions.body = params.toString();
			   }
			   try {
			              const response = await fetch(action, fetchOptions);

						  if (response.ok||response.status==302) {
						  		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
						  		       const html = await response.text();
						  		       document.open();
						  		       document.write(html);
						  		       document.close();
						  		   } else {
						  		       console.error('Errore nella richiesta:', response.status);
						  		   }
			           
			          } catch (error) {
			              console.error('Errore durante la richiesta:', error);
			          }
			   
    });
});






// Esempio di utilizzo
document.getElementById('logout').addEventListener('submit', async function (event) {
    event.preventDefault();

	localStorage.setItem("token","");
	
	const form = event.target;
	const actionUrl = form.getAttribute('action');

	console.log("action url:::"+actionUrl);
	window.location.href = actionUrl;
});


// Esempio di utilizzo
document.getElementById('loginForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

   	const nextAddress=await login(email, password);

    // Dopo il login, puoi fare altre chiamate API
});

async function loggedPage() {
    const url ="http://localhost:8081/gestionale/in/view";
	console.log("url in logged page :"+url);
    const token = localStorage.getItem('token');
	console.log(token);
    if (!token) {
        console.error('Token non trovato. Effettua il login prima di fare questa richiesta.');
        return;
    }

    const options = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        }
    };

    try {
		const response = await fetch(url, options);
		if (response.ok) {
		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
		       const html = await response.text();
		       document.open();
		       document.write(html);
		       document.close();
		   } else {
		       console.error('Errore nella richiesta:', response.status);
		   }

       // const data = await fetchWithAuth(url, options);
        console.log('Dati ricevuti:', response);
    } catch (error) {
        console.error('Errore nella chiamata API:', error);
    }
}




</script>
</html>


