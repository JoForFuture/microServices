</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta content="IE=edge" http-equiv="X-UA-Compatible">
	<style>
		/* styles.css */

		/* General styles */
		body {
		    font-family: Arial, sans-serif;
		    margin: 0;
		    padding: 20px;
		    background-color: #f0f2f5;
		}

		h1, h2, h3, h4 {
		    color: #333;
		    text-align: center;
		}

		h1 {
		    margin-bottom: 30px;
		}

		h3, h4 {
		    margin-bottom: 20px;
		}

		/* Button styles */
		button {
		    background-color: #007bff;
		    color: white;
		    border: none;
		    padding: 10px 20px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 16px;
		    cursor: pointer;
		    border-radius: 5px;
		    transition: background-color 0.3s ease;
		}

		button:hover {
		    background-color: #0056b3;
		}

		/* Form styles */
		form {
		    background: #fff;
		    padding: 20px;
		    border-radius: 10px;
		    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		    max-width: 400px;
		    margin: 20px auto;
		}

		input[type="text"],
		input[type="password"],
		input[type="number"],
		input[type="submit"] {
		    width: calc(100% - 20px);
		    padding: 10px;
		    margin: 10px 0;
		    border: 1px solid #ccc;
		    border-radius: 5px;
		}

		input[type="submit"] {
		    background-color: #28a745;
		    color: white;
		    border: none;
		    cursor: pointer;
		    transition: background-color 0.3s ease;
		}

		input[type="submit"]:hover {
		    background-color: #218838;
		}

		/* Form headings */
		form h3, form h4 {
		    text-align: center;
		}

		/* Layout and containers */
		div {
		    margin-bottom: 40px;
		}

		strong {
		    display: block;
		    text-align: center;
		    margin: 20px 0;
		}

		p {
		    text-align: center;
		}

		/* Special button container for header */
		.header-buttons {
			top: 10px;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		   	margin-bottom: 40px;
		}

		.header-buttons form {
		    margin: 20 10px;
		}

		/* Table styles */
		table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 20px;
		    border-radius: 10px;
		    overflow: hidden;
		    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		table th {
		    background-color: #007bff;
		    color: white;
		    padding: 10px;
		    text-align: left;
		}

		table td {
		    padding: 10px;
		    border-bottom: 1px solid #ddd;
		}

		/* Responsive styles */
		@media (max-width: 600px) {
		    .header-buttons {
		        flex-direction: column;
		    }

		    .header-buttons form {
		        margin: 10px 0;
		    }
		}

	</style>

	<title >Gestionale</title>
</head>

<body>
	<div class="header-buttons">

	     <form class="apiLink" th:action="@{/gestionale/in/view}" method="get">
	         <button type="submit">Home</button>
	     </form>
	     
	     <form id="logout" th:action="@{/auth/logout}" method="get">
	         <button type="submit">Logout</button>
	     </form>
	 </div>
	

	<h1 	id="gestionaleTitle">Gestionale</h1>

	

	<!--********************INDEX PAGE********************************-->
	<div th:if="${indexPage_isVisible eq true}">
		<!--  /gestionale/in/view-->
		<!-- Bottone per aggiungere un utente -->
		<form  class="apiLink" th:action="@{/formLogin/view}" method="get">
			<button type="submit">Login</button>
		</form>
		
	</div>
	
	<!--********************BEFORE LOGIN********************************-->
		<div  th:if="${beforeLoginPage_isVisible eq true}">
			<!-- Bottone per aggiungere un utente -->
			<h2>Access denied</h2>
			<h3>You can go back, change user or do your first login</h3>
			
			<form  class="apiLink, header-buttons" th:action="@{/formLogin/view}" method="get">
						<button type="submit">Login/change user</button>
			</form>
		
		</div>
		
	<!--********************GESTIONALE IN******************************
		
		**-->
	<div class="header-buttons" th:if="${gestionaleIn_isVisible eq true}">
		<!--<h2 th:text="'Benvenuto '+${user.getUsername()}+' !'"></h2>-->
		<!-- Bottone per aggiungere un utente -->
		<form 	class="apiLink" th:action="@{/private/addToPeopleGroup/view}" method="get">
			<button type="submit">Aggiungi persona</button>
		</form>
		<form 		class="apiLink" th:action="@{/searchPerson/view}" method="get">
			<button type="submit">Cerca persona</button>
		</form>
		<form 		class="apiLink" th:action="@{/api/view/person/getAll}" method="get">
			<button type="submit">Lista persone</button>
		</form>
		<!--<form 		class="apiLink" th:action="@{/api/view/person/getAllReactive}" method="get">
			<button type="submit">Lista persone reattiva</button>
		</form>-->

	</div>
	<!--************************FORM LOGIN*****************************************-->
	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formLogin_isVisible eq true}">
		<h3>Form login</h3>
		<!-- <form action="#" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post"> -->


		<form id="loginForm" th:if="${param.loginFailed}" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post">
			<input type="text" id="email" name="email" placeholder="Email" />
			<input type="password" id="password" name="password" placeholder="Password" />
			<button type="submit">Login</button>
		</form>

		<form 	id="loginForm" th:unless="${param.loginFailed}" th:action="@{/auth/login}" th:object="${LoginRequest}" method="post">
			<input type="text" id="email" name="email" th:value="${param.email}" placeholder="Email" />
			<input type="password" id="password" name="password" placeholder="Password" />
			<button type="submit">Login</button>
		</form>


		<!--  </form>  -->
	</div>

	<!--********************FORM ADD TO PEOPLE GROUP********************************-->

	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formAddToPeopleGroup_isVisible eq true}">
		<h3>Inserimento Persona</h3>
		<h4>Cognome e Nome sono obbligatori</h4>

		<form class="apiLink" action="#" th:action="@{/api/view/person/private/add}" th:object="${person}" method="post">

			<label for="surname">Cognome:</label>
			<input type="text" id="surname" th:field="*{surname}" required="true" /><br />
			
			<label for="name">Nome:</label>
			<input type="text" id="name" th:field="*{name}" required="true" /><br />

			<label for="age">Età:</label>
			<input type="number" id="age" th:field="*{age}" /><br />

			<input type="submit" value="Salva" />
		</form>
	</div>

	<!--********************FORM SEARCH PERSON********************************-->

	<!-- Mostra il form solo se non è stata ricevuta alcuna risposta -->
	<div th:if="${formSearchPerson_isVisible eq true}">
		<h3>Cerca persona</h3>
		<h4>Cognome e Nome sono obbligatori</h4>
<!--(surname=${person.surname},name=${person.name})-->
		<form class="apiLink" action="#"  th:action="@{/api/view/person/getByNameAndSurname}" th:object="${person}" method="get">
			

			<label for="surname">Cognome:</label>
			<input type="text" id="surname" th:field="*{surname}" required="true" /><br />
			
			<label for="name">Nome:</label>
			<input type="text" id="name" th:field="*{name}" required="true" /><br />

			<input type="submit" value="Cerca" />
		</form>
	</div>

	<!--********************GET PERSON DETAILS PAGE********************************-->

	<!-- Mostra la risposta ricevuta dal backend -->
	<div th:if="${getPersonDetailsPage_isVisible eq true}">
		
		<h3>Dettagli persona</h3>

		     <strong>
		         <p th:text="${response}"></p>
		     </strong>

		     <table>
		         <thead>
		             <tr>
		                 <th>ID</th>
						 <th>COGNOME</th>
		                 <th>NOME</th>
		                 <th>AGE</th>
		             </tr>
		         </thead>
		         <tbody>
		                 <td th:text="${person.getId()}"></td>
						 <td th:text="${person.getSurname()}"></td>
		                 <td th:text="${person.getName()}"></td>
		                 <td th:text="${person.getAge()}"></td>
		         </tbody>
		     </table>
		
			 <div class="header-buttons">

		<form class="apiLink" th:action="@{/private/updateMemberOfPeopleGroup/view(id=${person.getId()})}" method="get">
			
			

			<button type="submit">aggiorna </button>

		</form>
		<form  class="apiLink" th:action="@{/private/deleteMemberOfPeopleGroup/view(id=${person.getId()})}" method="get">

			<button type="submit">cancella </button>

		</form>

		</div>

	</div>

	<!--********************GET ALL PERSON********************************-->
	<!-- Mostra la risposta ricevuta dal backend -->
	<div th:if="${getPersonArray_isVisible eq true}">
		     <table>
		         <thead>
		             <tr>
		                 <th>ID</th>
						 <th>COGNOME</th>
		                 <th>NOME</th>
		                 <th>AGE</th>
		             </tr>
		         </thead>
		         <tbody>
		             <tr th:each="singlePerson : ${personList}">
		                 <td th:text="${singlePerson.getId()}"></td>
						 <td th:text="${singlePerson.getSurname()}"></td>
		                 <td th:text="${singlePerson.getName()}"></td>
		                 <td th:text="${singlePerson.getAge()}"></td>
		             </tr>
		         </tbody>
		     </table>
		 </div>
		
		<!--<h3>Lista persone</h3>

		<strong>
			<p th:text="${response}"></p>
		</strong>


		<td><strong>DETTAGLI PERSONA:</strong> </td>

		<tr th:each="singlePerson : ${personList}">
			<br>
						<td th:text="'ID : '+${singlePerson.getId()}"></td>
			<br>
			<td th:text="'NOME : '+${singlePerson.getName()}"></td>
			<br>
			<td th:text="'COGNOME : '+${singlePerson.getSurname()}"></td>
			<br>
			<td th:text="'AGE : '+${singlePerson.getAge()}"></td>
			<br>
			<br>
		</tr>-->


	</div>
	<!--********************GET ALL PERSON REACTIVE********************************-->

	<div>
		<!-- Mostra la risposta ricevuta dal backend -->
		<!--

		<div th:if="${getPersonArrayReactive_isVisible eq true}">
			<h3>Lista persone</h3>

			<strong>
				<p th:text="${response}"></p>
			</strong>


			<td><strong>DETTAGLI PERSONA:</strong> </td>
			
			<div>
				<th:tr th:each="single:${personFlux}">
					<td th:text="${personFlux}"></td>
					<br><br>
					<td th:text="${single}"></td>
					
				</th:tr>
			</div>

		
			
		</div>
	</div>-->
	<!--********************UPDATE PERSON********************************-->
	<div th:if="${updateMemberOfPeopleGroup_isVisible eq true}">
		<form class="apiLink" action="#" th:action="@{/api/view/person/private/update(id=${person.id})}" th:object="${person}"
			method="post">

			<input type="hidden" name="_method" value="PUT" />

			<!--<p th:text="'id :'+${person.getId()}"></p><input  type="hidden" id="id" name="id" th:value="${person.getId()}">-->
			<br>
			<p th:text="${person.getSurname()}"></p> <input type="text" id="surname" th:field="*{surname}">
			<br>
			<p th:text="${person.getName()}"></p> <input type="text" id="name" th:field="*{name}">
			<br>
			<p th:text="${person.getAge()}"></p> <input type="number" id="age" th:field="*{age}">
			<br>
			<input type="submit" value="Aggiorna" />



		</form>

	</div>
	<!--********************DELETE PERSON********************************-->
	<div th:if="${deleteMemberOfPeopleGroup_isVisible eq true}">
		<!--<div th:unless="${person.getId() ==null}">-->
		<form class="apiLink" action="#" th:action="@{/api/view/person/private/delete(id=${person.id})}" th:object="${person}"
			method="post">
			<h2>Conferma elimina dati persona</h2>
			<br>
			<p>Persona:</p>
			<input type="hidden" name="_method" value="DELETE" />

			<p th:text="'id :'+${person.getId()}"></p>
			<!--<input  type="hidden" id="id" name="id" th:value="${person.getId()}">-->
			<br>
			<p th:text="'surname :'+${person.getSurname()}"></p>
			<br>
			<p th:text="'name :'+${person.getName()}"></p>
			<br>
			<p th:text="'age :'+${person.getAge()}"></p>
			<br>
			<input type="submit" value="Cancella" />
		</form>
		<!-- </div>-->
		<!--	 <div th:if="${person.getId() == null}">
			<p th:text="${deleteMemberOfPeopleGroup_isVisible=false} = "></p>
			<p th:text="${gestionaleIn_isVisible_isVisible=true} = "></p>

		 </div>-->
	</div>
	<!--********************ERRORE INSERIMENTO********************************-->

	<div th:if="${getErrorPage_isVisible eq true}">
		<h1>Qualcosa non è andato bene!</h1>
		<br>
		<br>
		<!-- Mostra la risposta ricevuta dal backend 	 -->

		<strong>
			<p>L'errore è il seguente:</p>
		</strong>
		<p th:text="${errorMessage}"></p>

	</div>



</body>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
  console.log('DOM fully loaded and parsed');


  
  
  // Funzione per fare una richiesta al backend e gestire la risposta
  async function fetchWithAuth(url, options = {}) {
    try {
      const response = await fetch(url, options);

      if (response.ok) {
        const authHeader = response.headers.get('Authorization');

        if (authHeader && authHeader.startsWith('Bearer ')) {
          const token = authHeader.substring(7); // Rimuovi "Bearer "
          localStorage.setItem('token', token);
          return "authenticated";
        }
        
        throw new Error('Errore nella richiesta interna: ' + response.statusText);
      } else {
        throw new Error('Errore nella richiesta: ' + response.statusText);
      }
    } catch (error) {
      console.error('Errore:', error);
      throw error;
    }
  }

  // Funzione per effettuare il login e ottenere il token
  async function login(email, password) {
    const urlDoubleServer = 'http://security-service/auth/login';
    const url = '/auth/login';

    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, password })
    };

    try {
      const data = await fetchWithAuth(urlDoubleServer, options);
      console.log('Login avvenuto con successo:', data);
      return loggedPage();
    } catch (error) {
      try {
        const data = await fetchWithAuth(url, options);
        console.log('Login avvenuto con successo:', data);
        return loggedPage();
      } catch (error2) {
        console.error('Errore nel login:', error2);
      }
    }
  }

  // Esempio di utilizzo
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', async function (event) {
      event.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      await login(email, password);

      // Dopo il login, puoi fare altre chiamate API
    });
  }

  const apiLinks = document.querySelectorAll(".apiLink");
  apiLinks.forEach(function (element) {
    element.addEventListener('submit', async function (event) {
      event.preventDefault();

      const form = event.target;
      let action = form.action;
      const method = form.method.toUpperCase() || 'POST';

      const token = localStorage.getItem('token');
      const formData = new FormData(form);
      const params = new URLSearchParams();

      formData.forEach((value, key) => {
        params.append(key, value);
      });

      const fetchOptions = {
        method: method,
        headers: {
          'Authorization': 'Bearer ' + token
        }
      };

      if (method === 'GET') {
        if (params.toString()) {
          action += '?' + params.toString();
        }
      } else {
        fetchOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
        fetchOptions.body = params.toString();
      }

      try {
        const response = await fetch(action, fetchOptions);

        if (response.ok || response.status === 302) {
          const html = await response.text();
          document.open();
          document.write(html);
          document.close();
        } else {
          console.error('Errore nella richiesta:', response.status);
        }
      } catch (error) {
        console.error('Errore durante la richiesta:', error);
      }
    });
  });

  // Funzione di logout
  const logoutForm = document.getElementById('logout');
  if (logoutForm) {
    logoutForm.addEventListener('submit', function (event) {
      event.preventDefault();

      localStorage.removeItem('token');
      
      const actionUrl = event.target.action;
      console.log("Action URL:", actionUrl);
      window.location.href = actionUrl;
    });
  }

  // Funzione per caricare la pagina loggata
  async function loggedPage() {
    const url = "/gestionale/in/view";
    const token = localStorage.getItem('token');
    console.log("Token:", token);

    if (!token) {
      console.error('Token non trovato. Effettua il login prima di fare questa richiesta.');
      return;
    }

    const options = {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    };

    try {
      const response = await fetch(url, options);
      if (response.ok) {
        const html = await response.text();
        document.open();
        document.write(html);
        document.close();
      } else {
        console.error('Errore nella richiesta:', response.status);
      }
      console.log('Dati ricevuti:', response);
    } catch (error) {
      console.error('Errore nella chiamata API:', error);
    }
  }
});
</script>


<!--<script>
	
	// Funzione per fare una richiesta al backend e gestire la risposta
		async function fetchWithAuth(url, options = {}) {
			console.log("url"+url+" and options"+ options);
	    try {

	        const response = await fetch(url, options);

	        if (response.ok) {
			
					const authHeader = response.headers.get('Authorization');
					console.log("okokok "+authHeader);

	            if (authHeader && authHeader.startsWith('Bearer ')) {

	                const token = authHeader.substring(7); // Rimuovi "Bearer "

					localStorage.setItem('token', token);
					
					//const loc=response.headers.get('Location');
					return await "authenticated";//modificato qui

	            }
				
				throw new Error('Errore nella richiesta interno: ' + response.statusText);
				//response.json();
	        } else {
	            throw new Error('Errore nella richiesta: ' + response.statusText);
	        }
	    } catch (error) {
	        console.error('Errore:', error);
	        throw error;
	    }
	}

	
	
	// Funzione per effettuare il login e ottenere il token
		async function login(email, password) {
		    const urlDoubleServer = 'http://security-service/auth/login';
			const url = '/auth/login';

		    const options = {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify({ email, password })
		    };

		    try {

		        const data = await fetchWithAuth(urlDoubleServer, options);
		        console.log('Login avvenuto con successo:', data);
		        return 	loggedPage();
		;
		    } catch (error) {
				try{
					const data = await fetchWithAuth(url, options);
							console.log('Login avvenuto con successo:', data);
							return 	loggedPage();
				}catch(error2)
				{
					console.error('Errore nel login:', error);

				}
				

		    }
		};
	
	// Esempio di utilizzo
	document.getElementById('loginForm').addEventListener('submit', async function (event) {
	    event.preventDefault();

	    const email = document.getElementById('email').value;
	    const password = document.getElementById('password').value;

	   	const nextAddress=await login(email, password);

	    // Dopo il login, puoi fare altre chiamate API
	});
	
	
	
	



document.querySelectorAll(".apiLink").forEach(function(element) {
    element.addEventListener('submit', async function(event) {
        event.preventDefault();
		
		console.log("prima di if"); 

		const form = event.target;
		const action = form.action;
		const method = form.method.toUpperCase() || 'POST';
		
        const token = localStorage.getItem('token');
		
		const formData = new FormData(form);
		const params = new URLSearchParams();
		       formData.forEach((value, key) => {
		           params.append(key, value);
				   
		       });


		const fetchOptions = {
		           method: method,
		           headers: {
		              // 'Content-Type': 'application/x-www-form-urlencoded',
					   'Authorization': 'Bearer ' + localStorage.getItem('token')
		           }
		       };
			   if (method === 'GET') {
			       // Aggiungi i parametri all'URL per la richiesta GET
				   
					if (params === undefined || params === null || params == "" || params==" " ){

						action += params.toString();
					}else{
						action += '?' + params.toString();
					}
					

			   } else {
			       // Includi i parametri nel corpo per le richieste POST
			       fetchOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
			       fetchOptions.body = params.toString();
			   }
			   try {
			              const response = await fetch(action, fetchOptions);

						  if (response.ok||response.status==302) {
						  		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
						  		       const html = await response.text();
						  		       document.open();
						  		       document.write(html);
						  		       document.close();
						  		   } else {
						  		       console.error('Errore nella richiesta:', response.status);
						  		   }
			           
			          } catch (error) {
			              console.error('Errore durante la richiesta:', error);
			          }
			   
    });
});






// Esempio di utilizzo
document.getElementById('logout').addEventListener('submit', async function (event) {
    event.preventDefault();

	localStorage.setItem("token","");
	
	const form = event.target;
	const actionUrl = form.getAttribute('action');

	console.log("action url:::"+actionUrl);
	window.location.href = actionUrl;
});




async function loggedPage() {
    const url ="/gestionale/in/view";
	console.log("url in logged page :"+url);
    const token = localStorage.getItem('token');
	console.log(token);
    if (!token) {
        console.error('Token non trovato. Effettua il login prima di fare questa richiesta.');
        return;
    }

    const options = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        }
    };

    try {
		const response = await fetch(url, options);
		if (response.ok) {
		       // Ricevi la risposta HTML e sostituisci il contenuto della pagina corrente
		       const html = await response.text();
		       document.open();
		       document.write(html);
		       document.close();
		   } else {
		       console.error('Errore nella richiesta:', response.status);
		   }

       // const data = await fetchWithAuth(url, options);
        console.log('Dati ricevuti:', response);
		console.log("token alla fine"+localStorage.getItem('token'))
    } catch (error) {
        console.error('Errore nella chiamata API:', error);
    }
}




</script>-->
</html>


